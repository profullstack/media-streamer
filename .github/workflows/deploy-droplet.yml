# Deploy to DigitalOcean Droplet
# Deploys the application to a DigitalOcean Droplet via rsync + SSH
# Requires UDP ports open for BitTorrent DHT to work
#
# This workflow runs AFTER the CI workflow completes successfully
# to avoid duplicate test runs

name: Deploy to Droplet

on:
  # Run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

env:
  DEPLOY_PATH: /var/www/bittorrented
  DEPLOY_USER: bittorrented

jobs:
  # Deploy to Droplet (only if CI passed)
  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded (or manual trigger)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -p ${{ secrets.DROPLET_PORT || 22 }} -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Write .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Sync files to Droplet (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            rsync -azv --partial --progress --delete \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.next' \
              --exclude='.env.local' \
              --exclude='*.log' \
              -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.DROPLET_PORT || 22 }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=3" \
              ./ ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Build and restart on Droplet (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            ssh -i ~/.ssh/deploy_key \
                -p ${{ secrets.DROPLET_PORT || 22 }} \
                -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                -o ServerAliveInterval=15 \
                -o ServerAliveCountMax=3 \
                ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            echo "=== Starting build and restart ==="
            cd ${{ env.DEPLOY_PATH }}
            
            # Fix ownership
            sudo chown -R ${{ env.DEPLOY_USER }}:${{ env.DEPLOY_USER }} ${{ env.DEPLOY_PATH }}
            echo "✓ Ownership fixed"
            
            # Install dependencies
            pnpm install --frozen-lockfile
            echo "✓ Dependencies installed"
            
            # Build the application
            pnpm build
            echo "✓ Build complete"
            
            # Restart the application using systemd
            sudo systemctl restart bittorrented
            echo "✓ Service restarted"
            
            # Wait for service to start
            sleep 3
            
            # Verify deployment
            echo ""
            echo "=== Verifying deployment ==="
            sudo systemctl status bittorrented --no-pager || true
            ss -tlnp | grep 3000 || echo "Warning: Port 3000 not listening yet"
            ss -ulnp | grep 6881 || echo "Note: DHT port 6881 not bound yet"
            
            echo ""
            echo "=== Deployment complete! ==="
            DEPLOY_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

# Deploy to DigitalOcean Droplet
# Deploys the application to a DigitalOcean Droplet via rsync + SSH
# Requires UDP ports open for BitTorrent DHT to work
#
# This workflow runs AFTER the CI workflow completes successfully
# to avoid duplicate test runs

name: Deploy to Droplet

on:
  # Run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

env:
  # Deploy path: /home/ubuntu/www/:domain/:repo
  DEPLOY_PATH: /home/ubuntu/www/bittorrented.com/media-streamer
  SERVICE_NAME: bittorrented

jobs:
  # Deploy to Droplet (only if CI passed)
  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded (or manual trigger)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -p ${{ secrets.DROPLET_PORT || 22 }} -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Write .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Sync files to Droplet (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            # Create deploy directory if it doesn't exist
            ssh -i ~/.ssh/deploy_key \
                -p ${{ secrets.DROPLET_PORT || 22 }} \
                -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} \
                "mkdir -p ${{ env.DEPLOY_PATH }}"
            
            # Sync files
            rsync -azv --partial --progress --delete \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.next' \
              --exclude='.env.local' \
              --exclude='*.log' \
              -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.DROPLET_PORT || 22 }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=3" \
              ./ ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Build and restart on Droplet (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            ssh -i ~/.ssh/deploy_key \
                -p ${{ secrets.DROPLET_PORT || 22 }} \
                -o StrictHostKeyChecking=no \
                -o ConnectTimeout=30 \
                -o ServerAliveInterval=15 \
                -o ServerAliveCountMax=3 \
                ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            cd /home/ubuntu/www/bittorrented.com/media-streamer
            
            # Run idempotent setup script (installs Node, pnpm, ffmpeg, configures firewall, etc.)
            # This uses sudo which requires NOPASSWD for the ubuntu user
            echo "=== Running setup script ==="
            bash scripts/setup-server.sh
            
            # Source profile to get pnpm in PATH
            # Try multiple locations where pnpm might be installed
            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$HOME/.pnpm:$HOME/.npm-global/bin:/usr/local/bin:$PATH"
            
            # Source bashrc/profile if they exist
            [ -f ~/.bashrc ] && source ~/.bashrc 2>/dev/null || true
            [ -f ~/.profile ] && source ~/.profile 2>/dev/null || true
            
            echo ""
            echo "=== Environment ==="
            echo "PATH: $PATH"
            echo "Node: $(node --version 2>/dev/null || echo 'not found')"
            echo "pnpm: $(which pnpm 2>/dev/null || echo 'not found')"
            
            echo ""
            echo "=== Installing dependencies ==="
            pnpm install --frozen-lockfile
            echo "✓ Dependencies installed"
            
            echo ""
            echo "=== Building application ==="
            pnpm build
            echo "✓ Build complete"
            
            echo ""
            echo "=== Restarting service ==="
            # Use sudo with NOPASSWD (must be configured on server)
            sudo systemctl restart bittorrented || echo "Warning: Could not restart service (sudo may require password)"
            echo "✓ Service restart attempted"
            
            # Wait for service to start
            sleep 3
            
            # Verify deployment (don't use sudo for status check)
            echo ""
            echo "=== Verifying deployment ==="
            systemctl is-active bittorrented || echo "Service status unknown"
            ss -tlnp 2>/dev/null | grep 3000 || echo "Note: Port 3000 status unknown"
            
            echo ""
            echo "=== Deployment complete! ==="
            DEPLOY_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

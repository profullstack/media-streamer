# Deploy to DigitalOcean Droplet
# Deploys the application to a DigitalOcean Droplet via SSH
# Requires UDP ports open for BitTorrent DHT to work
#
# This workflow runs AFTER the CI workflow completes successfully
# to avoid duplicate test runs

name: Deploy to Droplet

on:
  # Run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

jobs:
  # Deploy to Droplet (only if CI passed)
  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded (or manual trigger)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write .env file to Droplet
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: ${{ secrets.DROPLET_PORT || 22 }}
          envs: ENV_FILE
          script: |
            # Write the entire .env file from secret
            echo "$ENV_FILE" > /var/www/bittorrented/.env
            echo ".env file written to Droplet"

      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: ${{ secrets.DROPLET_PORT || 22 }}
          script: |
            # Navigate to app directory
            cd /var/www/bittorrented
            
            # Determine branch name (main or master)
            BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
            
            # Pull latest code
            git fetch origin $BRANCH
            git reset --hard origin/$BRANCH
            
            # Fix ownership (in case git reset changed it)
            chown -R bittorrented:bittorrented /var/www/bittorrented
            
            # Install dependencies as bittorrented user
            sudo -u bittorrented pnpm install --frozen-lockfile
            
            # Build the application as bittorrented user
            sudo -u bittorrented pnpm build
            
            # Restart the application using systemd
            systemctl restart bittorrented
            
            echo "Deployment complete!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: ${{ secrets.DROPLET_PORT || 22 }}
          script: |
            # Check if app is running via systemd
            systemctl status bittorrented --no-pager
            
            # Check if port 3000 is listening
            ss -tlnp | grep 3000 || echo "Warning: Port 3000 not listening"
            
            # Check DHT UDP ports
            ss -ulnp | grep 6881 || echo "Note: DHT port 6881 not bound yet (will bind on first torrent)"
